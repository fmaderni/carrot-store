---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase, fileUrl } from '../../lib/supabaseClient';

export async function getStaticPaths() {
  // Traemos los slugs que estén activos y con stock
  const { data, error } = await supabase
    .from('products')
    .select('slug')
    .eq('is_active', true)
    .gt('stock', 0);

  if (error) {
    console.error(error);
    return { params: [] };
  }

  return {
    params: (data ?? []).map((r: any) => ({ slug: r.slug }))
  };
}

const { slug } = Astro.params;

const { data: items, error } = await supabase
  .from('products')
  .select('*')
  .eq('slug', slug)
  .limit(1);

if (error) {
  console.error(error);
  throw new Error('Error cargando producto');
}

const p = items?.[0];
if (!p) throw new Error('Producto no encontrado');

const fmt = new Intl.NumberFormat('es-UY', { style: 'currency', currency: 'UYU' });

const coverUrl = fileUrl(p.cover);
const imageUrls = (p.images ?? []).map((i: string) => fileUrl(i));
---

<BaseLayout title={p.title} description={p.summary ?? p.title}>
  <article class="mx-auto max-w-6xl px-4 py-10 grid gap-8 md:grid-cols-2">
    <div class="space-y-4">
      <img src={coverUrl} alt={p.title} class="w-full rounded-xl border" loading="eager" />
      {imageUrls.filter((img) => img !== coverUrl).map((img) => (
        <img src={img} alt={`${p.title} detalle`} class="w-full rounded-xl border" loading="lazy" />
      ))}
    </div>

    <div>
      <h1 class="text-3xl font-bold tracking-tight">{p.title}</h1>
      <p class="mt-2 text-2xl">{fmt.format(p.price)}</p>

      {p.sizes?.length ? (
        <p class="mt-4 text-sm">Talles: <strong>{p.sizes.join(', ')}</strong></p>
      ) : null}

      {p.colors?.length ? (
        <p class="mt-2 text-sm">Colores: <strong>{p.colors.join(', ')}</strong></p>
      ) : null}

      {p.summary ? <p class="mt-6 text-stone-700">{p.summary}</p> : null}

      <a href="/catalogo" class="mt-8 inline-block rounded-lg border px-4 py-2">← Volver al catálogo</a>
    </div>
  </article>
</BaseLayout>
