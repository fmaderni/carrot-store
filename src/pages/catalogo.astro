---
import BaseLayout from "../layouts/BaseLayout.astro";
import { createClient } from "@supabase/supabase-js";

// Cliente de Supabase usando las env PUBLIC_ (ya puestas en Cloudflare)
const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// Traemos todos los productos activos al momento del build
const { data: products, error } = await supabase
  .from("products")
  .select("id, slug, title, description, price, image_url, category, size, created_at")
  .eq("is_active", true)
  .order("created_at", { ascending: false });

if (error) {
  console.error("Error cargando catálogo desde Supabase:", error);
}
---

<BaseLayout title="Catálogo" description="Catálogo de productos de Carrot">
  <section class="mx-auto max-w-6xl px-4 py-10">
    <h1 class="text-3xl font-bold tracking-tight">Catálogo</h1>

    {(!products || products.length === 0) ? (
      <p class="mt-8 text-stone-600">No hay productos activos todavía.</p>
    ) : (
      <div class="mt-8 grid gap-6 sm:grid-cols-2 md:grid-cols-3">
        {
          products.map((p) => (
            <a href={`/producto/${p.slug}`} class="block rounded-lg border border-orange-200 bg-white/50 p-3 hover:shadow">
              {p.image_url ? (
                <img src={p.image_url} alt={p.title} class="aspect-square w-full rounded-md object-cover" loading="lazy" />
              ) : null}
              <div class="mt-3">
                <h3 class="font-medium">{p.title}</h3>
                <p class="mt-1 text-sm text-stone-600">{p.category}{p.size ? ` · ${p.size}` : ""}</p>
                {p.price ? <p class="mt-2 text-sm font-semibold">USD {p.price}</p> : null}
              </div>
            </a>
          ))
        }
      </div>
    )}
  </section>
</BaseLayout>
